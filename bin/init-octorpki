#!/usr/bin/perl

use warnings;
use strict;

use Cwd qw(cwd);
use autodie qw(:all);
use File::Slurp qw(read_file write_file);

my ($state_dir, $tal_path, $version) = @ARGV;

my $cwd = cwd();
if ($tal_path !~ /^\//) {
    $tal_path = "$cwd/$tal_path";
}

mkdir $state_dir;
chdir $state_dir;
mkdir "tals";
my ($real_tal_path) = read_file($tal_path);
system("cp $real_tal_path tals/tal.tal");
mkdir "cache";
my $exec = "/opt/octorpki-$version/bin/octorpki";
if (not -e $exec) {
    die "Validator version number is invalid.";
}
write_file("octorpki-link",
           "#!/bin/sh\n".
           "$exec ".
           "-allow.root ".
           "-tal.root=tals/tal.tal ".
           "-mode=oneoff ".
           "-output.sign=false");
chmod 0755, "octorpki-link";
system("chown -R rpki-client:rpki-client $state_dir");

1;
