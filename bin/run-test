#!/usr/bin/perl

use warnings;
use strict;

use autodie qw(:all);

my %validators = (
    routinator         => [qw(0.11.0 0.12.0 0.13.2 main)],
    fort               => [qw(1.5.3 1.5.4 1.6.1)],
    'rpki-client'      => [qw(7.0 8.7 9.0)],
    octorpki           => [qw(1.4.3 1.4.4 1.5.10)],
    'ripe-validator'   => [qw(2.24)],
    'ripe-validator-3' => [qw(3.2-2021.04.07.12.55)],
);

my $max_159        = "730750818665451459101842416358141509827966271487";
my $max_159_plus_1 = "730750818665451459101842416358141509827966271488";
my $max_160        = "1461501637330902918203684832716283019655932542975";
my $max_160_plus_1 = "1461501637330902918203684832716283019655932542976";

my %test_name_to_fn = (
    'manifest-number-reuse'             => \&manifest_number_reuse,
    'manifest-number-reuse-new-fn'      => \&manifest_number_reuse_new_fn,
    'manifest-number-regression'        => \&manifest_number_regression,
    'manifest-number-regression-new-fn' => \&manifest_number_regression_new_fn,
    'manifest-number-largest-value-159' => \&manifest_number_largest_value_159,
    'manifest-number-too-large-159'     => \&manifest_number_too_large_159,
    'manifest-number-largest-value-160' => \&manifest_number_largest_value_160,
    'manifest-number-too-large-160'     => \&manifest_number_too_large_160,
);

sub make_random_string
{
    my @chars = ('a'..'z', 0..9);

    return join '', map { $chars[int(rand(@chars))] } (1..8);
}

sub get_display_version
{
    my ($validator_version) = @_;

    my $display_version =
        ($validator_version =~ /\d/)
            ? "v$validator_version"
            : $validator_version;

    return $display_version;
}

sub manifest_number_reuse
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-reuse ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 1");
    print "Validator run (reused manifest number 1):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

sub manifest_number_reuse_new_fn
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-reuse-new-fn ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 1");
    print "Validator run (reused manifest number 1):\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 1 ".
           "--mft-filename new.mft");
    print "Validator run (reused manifest number 1, new filename):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

sub manifest_number_regression
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-regression ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 3");
    print "Validator run (manifest number 3):\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 2");
    print "Validator run (manifest number 2):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

sub manifest_number_regression_new_fn
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-regression-new-fn ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 3");
    print "Validator run (manifest number 3):\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 2");
    print "Validator run (manifest number 2):\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number 2 ".
           "--mft-filename new.mft");
    print "Validator run (manifest number 2, new filename):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

sub manifest_number_largest_value_159
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-largest-value-159 ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number $max_159");
    print "Validator run (largest possible manifest number value):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

sub manifest_number_too_large_159
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-too-large-159 ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number $max_159_plus_1");
    print "Validator run (manifest number value is too large):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

sub manifest_number_largest_value_160
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-largest-value-160 ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number $max_160");
    print "Validator run (largest possible manifest number value):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

sub manifest_number_too_large_160
{
    my ($validator_name, $validator_version) = @_;

    my $display_version = get_display_version($validator_version);
    print "manifest-number-too-large-160 ($validator_name $display_version)\n";
    system("/sbin/service rsync start >/dev/null");
    my $ta_name = make_random_string();
    system("setup-ca --name $ta_name --resources 1234");
    my $validator_dir = make_random_string();
    my $vp = "/tmp/$validator_dir";
    system("init-validator $vp last-tal-path ".
           "$validator_name $validator_version");
    print "Initial validator run:\n";
    system("run-validator $vp");
    print "End validator run\n";
    sleep(1);

    system("reissue-crl-and-mft --name $ta_name --mft-number $max_160_plus_1");
    print "Validator run (manifest number value is too large):\n";
    system("run-validator $vp");
    print "End validator run\n";
    print "---\n";
}

if (not @ARGV) {
    print "Usage: $0 {test-name} {validator-name} {validator-version}\n";
    print "\n";
    print "Test names:\n";
    print "  - manifest-number-reuse\n";
    print "  - manifest-number-regression\n";
    print "  - manifest-number-largest-value-159\n";
    print "  - manifest-number-too-large-159\n";
    print "  - manifest-number-largest-value-160\n";
    print "  - manifest-number-too-large-160\n";
    print "Validators:\n";
    for my $name (sort keys %validators) {
        my @versions = @{$validators{$name}};
        my $vstr = join ', ', @versions;
        print "  - $name ($vstr)\n";
    }
    print "\n";
    print "The string 'all' can also be used for each option,\n".
          "to test multiple versions of a validator, or multiple\n".
          "validators, or multiple tests.\n";
    exit(10);
}

my ($test_name, $validator_name, $validator_version) = @ARGV;

my @test_fns;
if ($test_name eq 'all') {
    @test_fns = @test_name_to_fn{qw(
        manifest-number-reuse
        manifest-number-reuse-new-fn
        manifest-number-regression
        manifest-number-regression-new-fn
        manifest-number-largest-value-159
        manifest-number-too-large-159
        manifest-number-largest-value-160
        manifest-number-too-large-160
    )};
} else {
    my $test_fn = $test_name_to_fn{$test_name};
    if (not $test_fn) {
        die "Invalid test name '$test_name'";
    }
    @test_fns = ($test_fn);
}

for my $test_fn (@test_fns) {
    if ($validator_name eq 'all') {
        for my $name (sort keys %validators) {
            for my $version (@{$validators{$name}}) {
                $test_fn->($name, $version);
            }
        }
    } else {
        if ($validator_version eq 'all') {
            for my $version (@{$validators{$validator_name}}) {
                $test_fn->($validator_name, $version);
            }
        } else {
            $test_fn->($validator_name, $validator_version);
        }
    }
}

1;
